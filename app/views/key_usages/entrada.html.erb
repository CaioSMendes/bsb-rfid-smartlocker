<div id="page-wrapper">
  <div class="container-fluid">
    <div class="row align-items-center mb-3">
      <div class="col-lg-6">
        <h1>
          <i class="fas fa-history"></i> Hist√≥rico de Movimenta√ß√µes
        </h1>
      </div>
      <div class="col-lg-6 text-right">
        <!-- Bot√µes lado a lado -->
        <div class="btn-group" role="group" aria-label="Hist√≥rico Bot√µes">
          <%= link_to entrada_key_usages_path, class: "btn btn-primary" do %>
            <i class="fas fa-list-alt"></i> Movimenta√ß√µes
          <% end %>

           <%= link_to key_usages_transactions_by_serial_path, class: "btn btn-secondary" do %>
            <i class="fas fa-exchange-alt"></i> Transa√ß√µes
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>


<div id="logs_table_container">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">

        <!-- üîç Formul√°rio de Filtros -->
        <div class="mb-2">
          <%= form_with url: entrada_key_usages_path, method: :get, local: true, class: "row g-2" do %>
            <!-- Colaborador -->
            <div class="col-md">
              <%= label_tag :employee_name, "Colaborador" %>
              <%= text_field_tag :employee_name, params[:employee_name], class: "form-control", placeholder: "Nome do colaborador" %>
            </div>

            <!-- Data inicial -->
            <div class="col-md">
              <%= label_tag :start_date, "Data Inicial" %>
              <%= date_field_tag :start_date, params[:start_date], class: "form-control" %>
            </div>

            <!-- Data final -->
            <div class="col-md">
              <%= label_tag :end_date, "Data Final" %>
              <%= date_field_tag :end_date, params[:end_date], class: "form-control" %>
            </div>

            <!-- A√ß√£o -->
            <div class="col-md">
              <%= label_tag :action, "A√ß√£o" %>
              <%= select_tag :action, options_for_select([["Todas", ""], ["Retirada", "retirada"], ["Devolu√ß√£o", "devolu√ß√£o"]], params[:action]), class: "form-control" %>
            </div>

            <!-- Status -->
            <div class="col-md">
              <%= label_tag :status, "Status" %>
              <%= select_tag :status, options_for_select([["Todos", ""], ["Com Alerta", "alert"], ["Sem Alerta", "ok"]], params[:status]), class: "form-control" %>
            </div>

            <div class="row">
              <!-- Bot√£o Filtrar -->
              <div class="col-md-1 align-self-end">
                <%= submit_tag "Filtrar", class: "btn btn-primary w-100 mb-3" %>
              </div>

              <!-- Bot√£o Exportar Excel -->
              <div class="col-md-1 align-self-end">
                <%= link_to entrada_key_usages_path(format: :xlsx, 
                      employee_name: params[:employee_name], 
                      start_date: params[:start_date], 
                      end_date: params[:end_date], 
                      log_action: params[:log_action], 
                      status: params[:status]), 
                      class: "btn btn-success w-100 mb-3" do %>
                  <i class="fas fa-file-excel"></i> Excel
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- üìã Tabela de Logs -->
        <div class="right_col mt-3" role="main">
          <div class="row">
            <div class="table-responsive">
              <table class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                  <tr>
                    <th><i class="fas fa-user"></i> Colaborador</th>
                    <th><i class="fas fa-calendar-alt"></i> Data e Hora</th>
                    <th><i class="fas fa-clipboard-check"></i> A√ß√£o</th>
                    <th><i class="fas fa-cogs"></i> Objeto</th>
                    <th><i class="fas fa-box-open"></i> Nome do Locker</th>
                    <th><i class="fas fa-lock"></i> Serial do Locker</th>
                    <th><i class="fas fa-comment-dots"></i> Coment√°rios</th>
                    <th><i class="fas fa-exclamation-triangle"></i> Alerta</th>
                    <th>  </th>
                  </tr>
                </thead>
                <tbody>
                  <% @logs_with_alert.each do |log_info| %>
                    <tr>
                      <!-- Colaborador -->
                      <td>
                        <i class="fas fa-user text-primary"></i>
                        <%= log_info[:log].employee.name %> <%= log_info[:log].employee.lastname %>
                      </td>

                      <!-- Data e Hora -->
                      <td>
                        <i class="fas fa-calendar-alt text-info"></i>
                        <%= log_info[:log].timestamp.strftime('%d/%m/%Y %H:%M:%S') %>
                      </td>

                      <!-- A√ß√£o -->
                      <td>
                        <% case log_info[:log].action %>
                        <% when 'retirada' %>
                          <i class="fas fa-sign-out-alt text-warning"></i> Retirada
                        <% when 'devolu√ß√£o' %>
                          <i class="fas fa-undo text-success"></i> Devolu√ß√£o
                        <% else %>
                          <i class="fas fa-question-circle text-secondary"></i> <%= log_info[:log].action %>
                        <% end %>
                      </td>

                      <!-- Objeto -->
                      <td>
                        <i class="fas fa-cogs text-dark"></i>
                        <%= log_info[:log].locker_object %>
                      </td>

                      <!-- Nome do Locker -->
                      <td>
                        <i class="fas fa-box-open text-primary"></i>
                        <%= log_info[:log].locker_name %>
                      </td>

                      <!-- Serial do Locker -->
                      <td>
                        <i class="fas fa-lock text-warning"></i>
                        <%= log_info[:log].locker_serial %>
                      </td>

                      <!-- Coment√°rios -->
                      <td>
                        <i class="fas fa-comment-dots text-secondary"></i>
                        <%= log_info[:log].comments %>
                      </td>

                      <!-- Alerta / Status -->
                      <td>
                        <% if log_info[:log].action == 'retirada' %>
                          <button class="btn <%= log_info[:alert] ? 'btn-danger' : 'btn-secondary' %>">
                            <i class="fas fa-exclamation-triangle"></i>
                            Objeto Retirado <%= "(‚ö†Ô∏è Alert!)" if log_info[:alert] %>
                          </button>
                        <% elsif log_info[:log].action == 'devolu√ß√£o' %>
                          <button class="btn btn-success">
                            <i class="fas fa-check-circle"></i> Objeto Devolvido
                          </button>
                        <% else %>
                          <i class="fas fa-info-circle"></i> <%= log_info[:log].action %>
                        <% end %>
                      </td>
                      <td>
                       <%= button_to destroy_log_key_usage_path(log_info[:log].id),
                                      method: :delete, 
                                      data: { confirm: "Tem certeza que deseja deletar este log?" }, 
                                      class: "btn btn-sm btn-danger" do %>
                          <i class="fas fa-trash"></i>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="text-center mt-3 d-flex justify-content-center">
  <nav aria-label="Page navigation">
    <ul class="pagination">
      <%= will_paginate @logs, renderer: WillPaginate::ActionView::BootstrapLinkRenderer %>
    </ul>
  </nav>
</div>

<script>
  function loadLogs() {
    $.ajax({
      url: "<%= entrada_key_usages_path %>",
      dataType: "html",
      success: function(data) {
        var html = $('<div>').html(data);
        var innerContent = html.find('#logs_table_container').html();
        $('#logs_table_container').html(innerContent);
      }
    });
  }

  $(document).ready(function() {
    loadLogs(); // carrega logo que abre a p√°gina
    setInterval(loadLogs, 5000); // atualiza a cada 5 segundos
  });
</script>